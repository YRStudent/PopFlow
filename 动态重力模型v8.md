# 动态重力模型（改进版）

## 1 简介

动态重力模型（Dynamic Gravity Model，DGM）是一类用于预测区域/城市间流动量（如人口迁移、客流、货物流等）的模型。基于经典重力模型的思想，本模型通过引入动态参数拟合、指标比值化处理、有效距离与多期参数外推等改进，使模型既能捕捉截面（年度）差异，又能进行多期预测与参数演化分析。

本模型核心目标：

1. **基于城市/区域属性与距离，解释并预测城市间流动量的空间分布**  
2. **支持多指标融合（PCA或原始指标），提高解释力与稳健性**  
3. **对每期独立估计参数，并能进行参数外推，实现多期预测**

---

## 2 原理

### 2.1 模型形式

**(1) 吸引力定义为：**
$$
A_{j,i}(t) = \prod_k\left(\frac{X_{j,k}(t-1)}{X_{i,k}(t-1)}\right)^{\theta_k(t-1)} \cdot d_{i\to j}(t-1)^{\gamma(t-1)}
$$

- $A_{j,i}$：表示从 $j$ 到 $i$ 的吸引力  
- $X_{i,k}$：城市 $i$ 的第 $k$ 个指标  
- $\theta_k$：各指标权重参数  
- $\gamma$：距离衰减参数  
- $d_{i\to j}$：从 $i$ 到 $j$ 的有效距离  
- $t-1$: 表示上一时期
- $t$：表示当期  

**上述公式表示为**：  
该公式描述了如何计算从一个地区（城市）$j$ 到另一个地区 $i$ 的相对吸引力 $A_{j,i}(t)$。这个吸引力是基于上一时期$(t-1)$的数据计算得出的，用于预测当期$(t)$的流动行为。 

*其中参数、变量均用上一时期的数值参与计算。*

**(2) 从吸引力计算流动概率：**
$$
P_{ij}(t) = \frac{A_{j,i}(t)}{\sum_j A_{j,i}(t)}
$$  

**上述公式表示为：**  
在所有可能对城市 $i$ 的吸引源头中，从特定城市 $j$ 对 $i$ 的吸引力概率或预期份额，为 $i$ 流向 $j$ 的流动概率。

**(3) 预测当前的流动量：**
$$
T_{ij}(t) = T_i(t-1) \cdot P_{ij}(t)
$$  
**上述公式表示为：**  
它用上一期流入目的地 $i$ 的总流量，乘以当前期从 $j$ 地来吸引力的概率份额，从而预测出当前期从 $j$ 到 $i$ 的具体流量值。  

---

### 2.2 参数估计

对每个时间截面 $t$，独立估计参数 $\theta_k(t)$ 与 $\gamma(t)$。

1. **特征计算**
   $$
   X_{ratio,ij} = \log \frac{X_j}{X_i}
   $$

2. **吸引力函数**
   $$
   A_{ji} = X_{ratio,ij} \cdot \theta - \gamma \cdot (\text{effD}_{ij} - 1)
   $$

3. **转化为流动概率**
   $$
   P_{ij} = \frac{e^{A_{ji}}}{\sum_j e^{A_{ji}}}
   $$

4. **定义负对数似然函数**
   $$
   L(\theta, \gamma) = -\sum_{i,j} T_i \cdot \log P_{ij}
   $$

5. **参数优化**
   - 使用 **L-BFGS-B** ，该算法是专门用来在有约束条件的情况下，为复杂的数学模型寻找“最佳”参数，其核心思想是通过观察目标函数值和梯度的变化，模拟出目标函数的“曲率”，从而找到一个更快的下降方向。在这里用来最小化 $L(\theta, \gamma)$；
   - 支持参数上下界约束（如 $\theta ≥ 0$, $\gamma ≥ 0$）。

---

### 2.3 参数外推预测  
通过2.2 估计的参数 进行时序上的参数外推，该部分支持三种时间序列外推方法：

#### （1）线性趋势外推（`linear`）
$$
\theta_k(t) = slope_k \cdot t + intercept_k
$$
$$
\gamma(t) = slope_\gamma \cdot t + intercept_\gamma
$$

#### （2）随机游走（`random walk`）
$$
\theta_k(t) = \theta_k(t-1) + \epsilon_t
$$
$$
\gamma(t) = \gamma(t-1) + \eta_t
$$
其中：
$$
\mu_{\theta_k} = mean(\Delta \theta_k), \quad
\mu_\gamma = mean(\Delta \gamma)
$$
预测下一期：
$$
\theta_k^{(T+1)} = \theta_k^{(T)} + \mu_{\theta_k}
$$
$$
\gamma^{(T+1)} = \gamma^{(T)} + \mu_\gamma
$$

#### （3）一阶自回归（`ar1`）
$$
\theta_k(t) = \rho_k \cdot \theta_k(t-1) + c_k + \epsilon_t
$$
$$
\gamma(t) = \rho_\gamma \cdot \gamma(t-1) + c_\gamma + \eta_t
$$
通过最小二乘法拟合 $\rho, c$：
$$
[\rho_k, c_k] = \arg\min_{\rho, c}\sum_t(\theta_k(t) - \rho\theta_k(t-1) - c)^2
$$
预测下一期：
$$
\theta_k^{(T+1)} = \rho_k \cdot \theta_k^{(T)} + c_k
$$
$$
\gamma^{(T+1)} = \rho_\gamma \cdot \gamma^{(T)} + c_\gamma
$$

---
### 2.4 补充  
当前数据处理是依据**主成分分析**进行降维处理，其目的是在尽可能保留原始数据主要信息的前提下，将高维特征映射到低维空间，从而简化计算并去除噪声。    

---


## 3 适用场景

### 优势
- **解释性强**：能揭示城市规模与距离对流动量的影响机制  
- **动态预测**：支持多期参数外推  
- **实现简洁**：计算效率高，指标权重直观  
- **灵活性强**：支持PCA、多指标与不同时间序列建模

### 局限性
- **短期拟合优于长期预测**  
- **对结构突变敏感**（如突发政策变动）  
- **可能存在内生性偏差**  
- **参数依赖数据质量，存在过拟合风险**


---

## 4 参数说明

| 参数名称 | 类型 | 取值范围 | 默认值 | 说明 |
|-----------|------|-----------|--------|------|
| `n_components` | 整数 | $[1, +\infty)$ | 2 | 主成分数（不超过指标数量） |
| `use_effective_distance` | 布尔 | {True, False} | True | 是否使用有效距离 |
| `fill_method` | 字符串 | {"mean", "zero"} | "mean" | 缺失值填充方式 |
| `mode` | 字符串 | {"linear", "random_walk", "ar1"} | "random_walk" | 参数外推方法 |

---

## 5 输入数据要求

输入数据为年度城市流动数据（DataFrame 格式），包含以下字段：  
**年份、来源地、目的地、城市间的流动量以及节点属性** ，具体如下所示：  


### 示例：
| year | Vi   | Vj   | Tij  | GDP   | Pop  |
|------|------|------|------|-------|------|
| 2020 | 郑州 | 开封 | 1200 | 98000 | 1010 |
| 2020 | 郑州 | 洛阳 | 950  | 98000 | 1010 |
| 2020 | 开封 | 郑州 | 1100 | 56000 | 680  |
| 2020 | 洛阳 | 郑州 | 970  | 72000 | 890  |


---

## 6 输出示例
- **模型训练: 包含参数 评估指标**

```json
{
    "city_count": 21,
    "theta_params": {
        "theta": [0.1985],
        "gamma": 1.0801
    },
    "training_metrics": {
        "R2": -0.0441,
        "MSE": 1309435230268.777,
        "RMSE": 1144305.5668,
        "MAE": 334306.1746,
        "MAPE": 4.17e+17,
        "SMAPE": 1.9837
    }
}

```
- **模型推断:**

```plain
预测结果:  
year	 Vi      Vj	  Tij_forecast
1759	2028	雅安市	1407507
1760	2028	雅安市	1407456
1761	2028	雅安市	1407479
1762	2028	雅安市	1406395
1763	2028	雅安市	1407998
...
```  